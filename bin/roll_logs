#!/bin/sh
#
# $Id$
#
# A script to truncate and mail out the MetaSOY server logs. This should be run
# on a nightly basis.

MSOY_HOME=`dirname $0`
MSOY_HOME=`cd $MSOY_HOME/..; pwd`

# read in the server configuration
if [ -f $MSOY_HOME/server.conf ]; then
    . $MSOY_HOME/server.conf
fi

NOW=`date "+%F-%H:%M"`
FILTLOG=`mktemp /tmp/msoyfiltered.log.XXXXXX` || exit 1
HOSTNAME=`hostname`

# make sure we have a log of non-zero size
for MSOYLOG in $MSOY_HOME/log/stdout-*.log ; do
    ARCHLOG=$MSOYLOG.$NOW
    if [ -s $MSOYLOG ]; then
        # roll over the server log file (the hard way)
        cp $MSOYLOG $ARCHLOG
        cp /dev/null $MSOYLOG
        # extract the node name
        NODE=`echo $MSOYLOG | sed 's:.*stdout-\(.*\).log:\1:'`
        # mail out some reports
        cat $ARCHLOG | $MSOY_HOME/tools/bin/sum_invokers > $FILTLOG
        if [ -s $FILTLOG ]; then
            cat $FILTLOG | $MAIL -s "$HOSTNAME: $MSOY_HOME $NODE invoker summary" $LOG_EMAIL
        fi
        # change directory to $MSOY_HOME so that filter_interesting can
        # maintain a local DBM file of interesting warning messages
        cd $MSOY_HOME
        cat $ARCHLOG | $MSOY_HOME/tools/bin/filter_interesting > $FILTLOG
        if [ -s $FILTLOG ]; then
            cat $FILTLOG | $MAIL -s "$HOSTNAME: $MSOY_HOME $NODE filtered log" $LOG_EMAIL
        fi
        rm -f $FILTLOG
    fi
done

# prune old logs
find $MSOY_HOME/log -name 'stdout.log*' -a -mtime +7 | xargs rm -f

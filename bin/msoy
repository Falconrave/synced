#!/bin/sh
#
# $Id$
#
# Startup script for the MetaSOY game server.

WHOAMI=`whoami`
if [ "$WHOAMI" != "root" ]; then
    echo "This script must be run as root."
    exit 255
fi

MSOY_HOME=`dirname $0`/..
MSOY_HOME=`cd $MSOY_HOME ; pwd`
if [ ! -f $MSOY_HOME/dist/server.conf ]; then
    echo "Unable to infer MSOY_HOME. No server.conf file?"
    exit 1
fi

# Read in our configuration
. $MSOY_HOME/dist/server.conf

# Use our hostname to compute an identifier for log files and such
PROCID=`hostname | sed 's:\..*::'`

# Let's blow that file descriptor limit wide open baby!
ulimit -n 4096

# Bump our maximum data segment size to 1.5 gigs
ulimit -d 1572864

# See how we were called
case "$1" in
  start)
        # Make sure msoyrespawn is not currently running
        if [ -f $MSOY_HOME/run/respawn-$PROCID.pid ]; then
            echo "msoyrespawn appears to be already running for $PROCID."
            echo "Run '$0 stop' to stop it first."
            exit 1
        fi

        # Make sure there are no hung MetaSOY server processes
        SERVER_PIDFILE=$MSOY_HOME/run/server-$PROCID.pid
        if [ -f $SERVER_PIDFILE ]; then
            PID=`cat $SERVER_PIDFILE`
            RPIDS=`ps auxww | grep " $PID " | grep java | awk '{ print $2 }' | \
                sort -n | head -1`
            if [ ! -z "$RPIDS" ]; then
                echo "WARNING: A $PROCID MsoyServer process is currently running."
                echo "If it has failed and you wish to forcibly restart it, please"
                echo "execute the following commands:"
                echo ""
                echo "% kill -QUIT $RPIDS"
                echo "% kill -KILL $RPIDS"
                echo ""
                echo "And then rerun this script."
                exit 255
            fi
        fi

        # Go ahead and start things up
        DAEMON=$MSOY_HOME/bin/msoyrespawn
        RESPAWN_PIDFILE=$MSOY_HOME/run/respawn-$PROCID.pid
        SERVER_PIDFILE=$MSOY_HOME/run/server-$PROCID.pid
        LOGFILE=$MSOY_HOME/log/respawn-$PROCID.log
        echo -n "Starting $DAEMON: "
        touch $RESPAWN_PIDFILE $LOGFILE
        $DAEMON $PROCID $RESPAWN_PIDFILE $SERVER_PIDFILE >>$LOGFILE 2>&1 </dev/null &
        echo "started."
        ;;

  stop)
        RESPAWN_PIDFILE=$MSOY_HOME/run/respawn-$PROCID.pid
        SERVER_PIDFILE=$MSOY_HOME/run/server-$PROCID.pid
        if [ ! -f $RESPAWN_PIDFILE ]; then
            echo "No $RESPAWN_PIDFILE exists. Is msoyrespawn running?"
        else
            echo -n "Shutting down msoy $PROCID, "
            kill `cat $SERVER_PIDFILE`
            echo -n "msoyrespawn: "
            kill `cat $RESPAWN_PIDFILE`
            echo "stopped."
            rm -f $RESPAWN_PIDFILE $SERVER_PIDFILE
        fi
        ;;

  unspawn)
        RESPAWN_PIDFILE=$MSOY_HOME/run/respawn-$PROCID.pid
        if [ ! -f $RESPAWN_PIDFILE ]; then
            echo "No $RESPAWN_PIDFILE exists. Is msoyrespawn running?"
        else
            echo -n "Shutting down msoyrespawn: "
            kill `cat $RESPAWN_PIDFILE`
            echo "stopped."
            rm -f $RESPAWN_PIDFILE
        fi
        ;;

  restart)
        SERVER_PIDFILE=$MSOY_HOME/run/server-$PROCID.pid
        if [ ! -f $SERVER_PIDFILE ]; then
            echo "No $SERVER_PIDFILE exists. Is the server running?"
        else
            echo -n "Shutting down msoy $PROCID: "
            kill `cat $SERVER_PIDFILE`
            echo "stopped. Check to be sure that it automatically restarts."
            rm -f $SERVER_PIDFILE
        fi
        ;;

  *)
        echo "Usage: $0 {start|stop|unspawn|restart}"
        exit 1
esac

exit 0

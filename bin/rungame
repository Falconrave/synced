#!/bin/sh
#
# $Id$
#
# Runs a game hosting server.

NAME=msoy
DESC="MetaSOY game server"

MSOY_HOME=`dirname $0 | sed s:/bin$::`
HOSTNAME=`hostname`

# Make sure our game id and port were properly supplied.
if [ -z "$1" -o -z "$2" ]; then
    echo "Usage: $0 listenPort connectPort"
    exit 255
fi
LISTEN_PORT=$1
CONNECT_PORT=$2

LOGFILE=$MSOY_HOME/log/stdout-p$LISTEN_PORT.log
LOG_EMAIL=nightly-logs@threerings.net

# Override settings with those from MSOY_HOME/dist/msoy-server.conf
if [ -f $MSOY_HOME/dist/msoy-server.conf ]; then
    . $MSOY_HOME/dist/msoy-server.conf
else
    echo "Can't load $MSOY_HOME/dist/msoy-server.conf; can't run server."
    exit 255
fi

CLASS=com.threerings.msoy.game.server.MsoyGameServer
JAVA_ARGS="-server \
    -Djava.awt.headless=true \
    -Dhostname=$HOSTNAME \
    -Dresource_dir=$MSOY_HOME/rsrc \
    -Drsrc_cache_dir=/tmp \
    -Djava.security.manager -Djava.security.policy=$MSOY_HOME/dist/security.policy \
    -Djava.rmi.server.hostname=$HOSTNAME \
    -Dlog4j.configuration=log4j-game.properties \
    -Djava.util.logging.config.file=$MSOY_HOME/dist/logging.properties \
    -Dorg.apache.commons.logging.Log=org.apache.commons.logging.impl.Log4JLogger \
    -Dehcache.disk.store.dir=game"

#JDWP_ARGS="transport=dt_socket,server=y,address=8001,suspend=n";
#JAVA_ARGS="-agentlib:jdwp=$JDWP_ARGS $JAVA_ARGS"

# make sure we have a JVM and set up our classpath and bits
. $MSOY_HOME/bin/runcommon

# Create the logfile
touch $LOGFILE

# Start up the server
$JAVA_VM $JAVA_ARGS $CLASS $LISTEN_PORT $CONNECT_PORT >>$LOGFILE 2>&1
EXIT_CODE=$?

# If any stdout or stderr logs were generated, send those via email (all normal
# logs should be redirected to a separate file)
if [ -s $LOGFILE ]; then
    cat $LOGFILE | $MAIL -s "$HOSTNAME: $MSOY_HOME p$LISTEN_PORT stray log output" $LOG_EMAIL
fi
rm -f $LOGFILE

exit $EXIT_CODE

/* Facebook Connect helper crap (mostly because GWT + Facebook Connect == Fail). */
window.FB_WithInit = function(callback) {
    FB_RequireFeatures(["Api", "Connect", "XFBML"], function() {
        FB.init("@FB_API_KEY@", "/fbconnect.html");
    });
    window.FB_WithInit = FB.Bootstrap.ensureInit;
    FB_WithInit(function() {
        callback();
    });
};

window.FB_RequireSession = function() {
    FB_WithInit(function() {
        FB.Connect.requireSession(function() {
            if (FB_RequireSessionCallback) {
                FB_RequireSessionCallback(FB.Facebook.apiClient.get_session().uid);
                FB_RequireSessionCallback = null;
            }
        });
    });
};

window.FB_PostStory = function(bundleId, data, targetIds, body, callback) {
    var showingFeed = false;
    FB_WithInit(function() {
        FB.Connect.requireSession(function() {
            if (!showingFeed) {
                showingFeed = true;
                FB.Connect.showFeedDialog(bundleId, data, targetIds, body, null,
                    FB.RequireConnect.promptConnect, callback);
            }
        });
    });
};

window.FB_PostTrophy = function(templateId, data, callback) {
    FB_PostStory(templateId, data, [], "", callback);
};

window.FB_PostChallenge = function(templateId, data, callback) {
    FB_PostStory(templateId, data, [], "", callback);
};

window.FB_Logout = function() {
    FB_WithInit(function() {
        FB.Connect.logout(null);
    });
};

window.FB_ParseXFBML = function (id) {
    FB_WithInit(function() {
        var elem = document.getElementById(id);
        if (elem != null) {
            FB.XFBML.Host.parseDomElement(elem);
        }
    });
}

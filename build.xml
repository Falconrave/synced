<!-- build configuration -->
<project name="msoy" default="compile" basedir=".">

  <!-- define some basic project parameters -->
  <property name="app.name"         value="msoy"/>
  <property name="doc.packages"     value="com.threerings.msoy.*"/>
  <property name="copy.holder"      value="Three Rings Design, Inc."/>

  <!-- read in our deployment properties -->
  <property file="server.properties"/>
  <property file="build.properties"/>
  <property file="${cert_dir}/certificate.properties"/>

  <!-- things you probably don't want to change -->
  <property name="src.dir"      value="src/java"/>
  <property name="deploy.dir"   value="dist"/>
  <property name="javadoc.dir"  value="${deploy.dir}/docs"/>
  <property name="savedoc.dir"  value="docs"/>
  <property name="gwtout.dir"   value="pages"/>

  <!-- declare our classpath -->
  <path id="classpath">
    <pathelement location="${deploy.dir}/classes"/>
    <fileset dir="dist" includes="${app.name}-code.jar"/>
    <fileset dir="lib" includes="*.jar"/>
    <fileset dir="/export/tools/lib/java" includes="**/*.jar"/>
  </path>

  <!-- special bits used by GWT -->
  <path id="gwt.classpath">
    <fileset dir="lib" includes="**/*.jar"/>
    <pathelement location="${deploy.dir}/classes"/>
    <pathelement location="src/java"/>
    <pathelement location="src/gwt"/>
  </path>

  <!-- runs the GWT debugging shell -->
  <property name="page"  value="index.html"/>
  <target name="gshell">
    <java classpathref="gwt.classpath" fork="true"
          classname="com.google.gwt.dev.GWTShell">
      <sysproperty key="msoy.home" value="."/>
      <arg value="-out"/>
      <arg value="${gwtout.dir}"/>
      <arg value="${app.name}/${page}"/>
    </java>
  </target> 

  <!-- builds our GWT web client -->
  <target name="gclient">
    <delete dir="pages/msoy"/>
    <mkdir dir="pages/msoy"/>
    <delete><fileset dir="pages/msoy" includes="*/*.*"/></delete>
    <java classpathref="gwt.classpath" fork="true"
          classname="com.google.gwt.dev.GWTCompiler">
      <!--<arg value="-style"/>-->
      <!--<arg value="PRETTY"/>-->
      <arg value="-out"/>
      <arg value="${gwtout.dir}"/>
      <arg value="${app.name}"/>
    </java>
  </target> 

  <!-- prepares to build our Flash client -->
  <target name="asprepare">
    <mkdir dir="pages/clients"/>
    <tstamp>
      <format property="build_time" pattern="yyyy-MM-dd HH:mm:ss"/>
    </tstamp>
    <copy file="src/as/com/threerings/msoy/client/DeploymentConfig.as.tmpl"
          tofile="src/as/com/threerings/msoy/client/DeploymentConfig.as"
          overwrite="true">
      <filterset>
        <filter token="build_time" value="${build_time}"/>
        <filter token="server_host" value="${server_host}"/>
        <filter token="server_ports" value="${server_ports}"/>
      </filterset>
    </copy>
  </target>

  <target name="checkaslib">
    <uptodate property="aslib_is_up_to_date" targetfile="lib/naryavilya.swc">
      <srcfiles dir="projects/narya/src/as" includes="**/*.as"/>
      <srcfiles dir="projects/vilya/src/as" includes="**/*.as"/>
      <srcfiles dir="projects/toybox/src/as" includes="**/*.as"/>
    </uptodate>
  </target>

  <!-- builds our Flash library -->
  <target name="aslib" unless="aslib_is_up_to_date" depends="checkaslib">
    <java jar="lib/as-compiler/lib/compc.jar" fork="true" failonerror="true">
      <arg value="-locale"/>
      <arg value="en_US"/>
      <arg value="-compiler.optimize"/>
      <arg value="-compiler.external-library-path"/>
      <arg value="lib/as-compiler/frameworks/libs"/>
      <arg value="lib/as-compiler/frameworks/locale/en_US"/>
      <arg value="-load-config"/>
      <arg value="lib/as-compiler/frameworks/flex-config.xml"/>
      <arg value="-compiler.warn-class-is-sealed=true"/>
      <arg value="-compiler.warn-constructor-returns-value=true"/>
      <arg value="-compiler.fonts.local-fonts-snapshot=lib/as-compiler/frameworks/localFonts.ser"/>
      <arg value="-compiler.source-path=projects/narya/src/as/"/>
      <arg value="-compiler.source-path=projects/vilya/src/as/"/>
      <arg value="-compiler.source-path=projects/toybox/src/as/"/>
      <arg value="-include-sources=projects/narya/src/as/"/>
      <arg value="-include-sources=projects/vilya/src/as/"/>
      <arg value="-include-sources=projects/toybox/src/as/"/>
      <arg value="-output"/>
      <arg value="lib/naryavilya.swc"/>
    </java>
  </target>

  <!-- builds our Flash client -->
  <target name="asclient" depends="asprepare,aslib">
    <java jar="lib/as-compiler/lib/mxmlc.jar" fork="true" failonerror="true">
      <arg value="-locale"/>
      <arg value="en_US"/>
      <arg value="-compiler.optimize"/>
      <arg value="-compiler.library-path"/>
      <arg value="lib"/>
      <arg value="lib/as-compiler/frameworks/libs"/>
      <arg value="lib/as-compiler/frameworks/locale/en_US"/>
      <arg value="-load-config"/>
      <arg value="lib/as-compiler/frameworks/flex-config.xml"/>
      <arg value="-link-report"/>
      <arg value="/tmp/link-report.txt"/>
      <arg value="-resource-bundle-list"/>
      <arg value="/tmp/bundles.list"/>
      <!--<arg value="-compiler.keep-all-type-selectors=true"/>-->
      <arg value="-compiler.warn-class-is-sealed=true"/>
      <arg value="-compiler.warn-constructor-returns-value=true"/>
      <arg value="-compiler.fonts.local-fonts-snapshot=lib/as-compiler/frameworks/localFonts.ser"/>
      <arg value="-compiler.source-path=src/as/"/>
      <arg value="-compiler.source-path=rsrc/{locale}/i18n"/>
      <arg value="-output"/>
      <arg value="dist/game-client.swf"/>
      <arg value="-file-specs"/>
      <arg value="src/as/Msoy.mxml"/>
    </java>
    <copy file="dist/game-client.swf" todir="pages/clients"/>
  </target>

  <!-- builds our Flash debug client -->
  <target name="asdebug" depends="asprepare,aslib">
    <java jar="lib/as-compiler/lib/mxmlc.jar" fork="true" failonerror="true">
      <arg value="-locale"/>
      <arg value="en_US"/>
      <arg value="-compiler.debug"/>
      <arg value="-compiler.verbose-stacktraces=true"/>
      <arg value="-compiler.library-path"/>
      <arg value="lib"/>
      <arg value="lib/as-compiler/frameworks/libs"/>
      <arg value="lib/as-compiler/frameworks/locale/en_US"/>
      <arg value="-load-config"/>
      <arg value="lib/as-compiler/frameworks/flex-config.xml"/>
      <arg value="-link-report"/>
      <arg value="/tmp/link-report.txt"/>
      <arg value="-resource-bundle-list"/>
      <arg value="/tmp/bundles.list"/>
      <arg value="-compiler.warn-class-is-sealed=true"/>
      <arg value="-compiler.warn-constructor-returns-value=true"/>
      <arg value="-compiler.fonts.local-fonts-snapshot=lib/as-compiler/frameworks/localFonts.ser"/>
      <arg value="-compiler.source-path=src/as/"/>
      <arg value="-compiler.source-path=rsrc/{locale}/i18n"/>
      <arg value="-output"/>
      <arg value="dist/game-client.swf"/>
      <arg value="-file-specs"/>
      <arg value="src/as/Msoy.mxml"/>
    </java>
    <copy file="dist/game-client.swf" todir="pages/clients"/>
  </target>

  <!-- builds and signs our Java game client -->
  <target name="jclient">
    <taskdef resource="proguard/ant/task.properties"
             classpath="lib/proguard.jar"/>
    <!-- On Mac OS X, rt.jar is cleverly renamed classes.jar -->
    <condition property="isDarwin">
      <and>
        <os family="mac"/>
        <os family="unix"/>
      </and>
    </condition>
    <condition property="rtClasses"
               value="${java.home}/../Classes/classes.jar">
      <istrue value="${isDarwin}"/>
    </condition>
    <condition property="rtClasses"
               value="${java.home}/lib/rt.jar">
      <isfalse value="${isDarwin}"/>
    </condition>
    <mkdir dir="${deploy.dir}"/>
    <proguard configuration="etc/game-client.pro">
      <libraryjar name="${rtClasses}"/>
    </proguard>
    <signjar lazy="true" keystore="${cert_dir}/lib/keystore.dat"
      storepass="${sign.storepass}" alias="${sign.alias}">
      <fileset dir="${deploy.dir}" includes="game-client.jar"/>
    </signjar>
    <copy file="${deploy.dir}/game-client.jar" todir="pages/clients"/>
  </target>

  <!-- generates additional methods for distributed object classes -->
  <target name="gendobj" depends="prepare">
    <taskdef name="dobj"
             classname="com.threerings.presents.tools.GenDObjectTask"
             classpathref="classpath"/>
    <!-- make sure the dobject class files are all compiled -->
    <javac srcdir="src/java" destdir="${deploy.dir}/classes"
           debug="on" optimize="${build.optimize}" deprecation="on">
      <classpath refid="classpath"/>
      <include name="**/*Object.java"/>
    </javac>
    <!-- now generate the associated files -->
    <dobj classpathref="classpath">
      <fileset dir="src/java" includes="**/*Object.java"/>
    </dobj>
  </target>

  <!-- generates marshaller and dispatcher classes for all invocation -->
  <!-- service declarations -->
  <target name="genservice"> 
    <taskdef name="service"
             classname="com.threerings.presents.tools.GenServiceTask"
             classpathref="classpath"/>
    <!-- make sure the service class files are all compiled -->
    <javac srcdir="src/java" destdir="${deploy.dir}/classes"
           debug="on" optimize="${build.optimize}" deprecation="on">
      <classpath refid="classpath"/>
      <include name="**/*Service.java"/>
      <exclude name="**/web/**"/>
    </javac>
    <!-- now generate the associated files -->
    <service header="lib/SOURCE_HEADER" classpathref="classpath">
      <fileset dir="src/java" includes="**/*Service.java" excludes="**/web/**"/>
    </service>
  </target>

  <!-- generates sender and decoder classes for all invocation -->
  <!-- receiver declarations -->
  <target name="genreceiver"> 
    <taskdef name="receiver"
             classname="com.threerings.presents.tools.GenReceiverTask"
             classpathref="classpath"/>
    <!-- make sure the receiver class files are all compiled -->
    <javac srcdir="src/java" destdir="${deploy.dir}/classes"
           debug="on" optimize="${build.optimize}" deprecation="on">
      <classpath refid="classpath"/>
      <include name="**/*Receiver.java"/>
      <exclude name="**/InvocationReceiver.java"/>
    </javac>
    <!-- now generate the associated files -->
    <receiver header="lib/SOURCE_HEADER" classpathref="classpath">
      <fileset dir="src/java" includes="**/*Receiver.java"
        excludes="**/InvocationReceiver.java"/>
    </receiver>
  </target>

  <!-- prepares the application directories -->
  <target name="prepare">
    <mkdir dir="${deploy.dir}"/>
    <mkdir dir="${deploy.dir}/classes"/>
    <mkdir dir="${deploy.dir}/classes/rsrc"/>
    <mkdir dir="${javadoc.dir}"/>
    <copy todir="${deploy.dir}/classes/rsrc">
      <fileset dir="rsrc">
       <include name="**/*"/>
      </fileset>
    </copy>
    <!-- create our toybox properts from server.properties -->
    <exec executable="egrep">
      <arg line="^toybox\."/>
      <arg line="server.properties"/>
      <redirector output="${deploy.dir}/classes/toybox.properties">
        <outputfilterchain>
          <replacestring from="toybox." to=""/>
        </outputfilterchain>
      </redirector>
    </exec>
  </target>

  <!-- creates the serialized color repository config -->
  <target name="colorpos">
    <taskdef name="confcomp" classpathref="classpath"
      classname="com.threerings.tools.CompiledConfigTask"/>
    <confcomp parser="com.threerings.media.image.tools.xml.ColorPositoryParser"
      configdef="rsrc/config/media/colordefs.xml"/>
  </target>

  <!-- run the unit tests -->
  <target name="tests" depends="compile" description="Runs unit tests.">
    <taskdef name="unit" classpathref="classpath"
      classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask"/>
    <unit printsummary="no" haltonfailure="yes" fork="true">
      <classpath refid="classpath"/>
      <formatter type="brief" usefile="false"/>
      <batchtest>
        <fileset dir="${src.dir}" includes="**/*UnitTest.java"/>
      </batchtest>
    </unit>
  </target>

  <!-- cleans out the compiled code -->
  <target name="clean">
    <delete dir="${deploy.dir}/classes/com"/>
  </target>

  <!-- fully cleans out the installed application -->
  <target name="distclean">
    <delete dir="${deploy.dir}"/>
    <delete><fileset dir="rsrc" includes="**/*.jar"/></delete>
  </target>

  <!-- build the java class files -->
  <target name="compile" depends="prepare">
    <javac srcdir="${src.dir}" destdir="${deploy.dir}/classes"
           debug="on" optimize="off" deprecation="on">
      <classpath refid="classpath"/>
      <compilerarg value="-Xlint:unchecked"/>
    </javac>
  </target>

  <!-- build the javadoc documentation -->
  <target name="javadoc" depends="prepare">
    <javadoc sourcepath="${src.dir}"
             packagenames="${doc.packages}"
             windowtitle="${app.name} API"
             doctitle="${app.name} API"
             bottom="Copyright &#169; 2005 ${copy.holder}. All Rights Reserved."
             destdir="${javadoc.dir}"
             additionalparam="-breakiterator">
      <classpath refid="classpath"/>
      <link href="http://java.sun.com/j2se/1.5/docs/api/"/>
    </javadoc>
  </target>

  <!-- builds the javadocs and stuffs them in a directory where they -->
  <!-- won't be blown away when we do "clean" next time -->
  <target name="savedoc" depends="javadoc">
    <delete dir="${savedoc.dir}/api"/>
    <copy todir="${savedoc.dir}/api">
      <fileset dir="${javadoc.dir}" includes="**/*"/>
    </copy>
  </target>

  <!-- a target for rebuilding everything -->
  <target name="all" depends="clean,prepare,compile,javadoc,dist"/>

  <!-- rebuild all the niggling bits -->
  <target name="bits" depends="colorpos"/>

  <!-- builds the distribution jar files -->
  <target name="dist" depends="prepare,compile">
    <!-- stick all our code in one jar file -->
    <jar file="${deploy.dir}/${app.name}-code.jar"
         basedir="${deploy.dir}/classes">
      <include name="com/**"/>
      <include name="*.properties"/>
    </jar>
    <!-- and all of our configuration and media in another -->
    <jar file="${deploy.dir}/${app.name}-media.jar"
         basedir="${deploy.dir}/classes" includes="rsrc/**"/>
  </target>

</project>

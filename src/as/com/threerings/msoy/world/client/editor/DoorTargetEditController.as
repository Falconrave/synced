//
// $Id$

package com.threerings.msoy.world.client.editor {

import flash.events.MouseEvent;

import mx.containers.Canvas;
import mx.containers.HBox;
import mx.containers.VBox;
import mx.controls.Button;
import mx.controls.Text;
import mx.core.Container;
import mx.core.ScrollPolicy;

import com.threerings.io.TypedArray;

import com.threerings.presents.client.ResultWrapper;

import com.threerings.whirled.client.SceneDirector;
import com.threerings.whirled.data.Scene;
import com.threerings.whirled.data.SceneUpdate;

import com.threerings.msoy.chat.client.ReportingListener;
import com.threerings.msoy.client.Msgs;
import com.threerings.msoy.client.WorldContext;
import com.threerings.msoy.ui.FloatingPanel;

import com.threerings.msoy.world.client.RoomController;
import com.threerings.msoy.world.client.RoomView;
import com.threerings.msoy.world.client.updates.FurniUpdateAction;
import com.threerings.msoy.world.data.FurniData;
import com.threerings.msoy.world.data.ModifyFurniUpdate;
import com.threerings.msoy.world.data.MsoyLocation;
import com.threerings.msoy.world.data.MsoyScene;
import com.threerings.msoy.world.data.RoomObject;

/**
 * This controller handles in-world door editing. The player picks a door to edit, then travels
 * the whirled in search of a target room. Once target is selected, the player will be returned
 * to the door location, and the door will be set to point to the target scene.
 *
 * Note: this object is a singleton, because it needs to exist independently of the different
 * room views that get created when player moves between scenes.
 */
public class DoorTargetEditController
{
    /**
     * Singleton constructor. Do not instantiate the singleton directly - use the static
     * function start() instead.
     */
    public function DoorTargetEditController ()
    {
        // this would be simpler if Actionscript supported non-public constructors. why doesn't it?
        if (_this != null) {
            throw new Error("DoorTargetEditController must not be instantiated directly.");
        }
    }

    /** Returns true if a door is currently being edited. */
    public static function get editing () :Boolean
    {
        return (_this._doorScene != 0);
    }

    /**
     * Returns true if a door is currently being edited, and we're in the middle of
     * committing a new door target selection.
     */
    protected static function get committing () :Boolean
    {
        return editing && (_this._destinationScene != 0);
    }

    /**
     * Start editing a door. Displays the target editor window, which waits for the player to click
     * on a 'submit' button to specify target location.
     */
    public static function start (doorData :FurniData, ctx :WorldContext) :void
    {
        if (editing) {
            _this.deinit();
        } else {
            _this.init(doorData, ctx);
        }
    }

    /**
     * Initializes all internal data structures.
     */
    protected function init (doorData :FurniData, ctx :WorldContext) :void
    {
        _ctx = ctx;
        _container = ctx.getTopPanel().getPlaceContainer();
        _ui = makeUI();
        _ui.open();
        _ui.x = _ui.y = 0;

        _doorScene = _ctx.getSceneDirector().getScene().getId();
        _doorId = doorData.itemId;

        _destinationScene = 0;
        _destinationLoc = null;
    }

    /**
     * Shuts down any editing data structures.
     */
    protected function deinit (doorData :FurniData = null) :void
    {
        // if we got update info...
        if (doorData != null) {
            // ...create a furni update based on the door data, and send it to the server.
            var ctrl :RoomController =
                _ctx.getLocationDirector().getPlaceController() as RoomController;

            var newdata :FurniData = doorData.clone() as FurniData;
            newdata.actionData = _destinationScene + ":" + roundCoord(_destinationLoc.x) + ":" +
                roundCoord(_destinationLoc.y) + ":" +  roundCoord(_destinationLoc.z) + ":" +
                _destinationLoc.orient + ":" + _ctx.getSceneDirector().getScene().getName();

            ctrl.applyUpdate(new FurniUpdateAction(_ctx, doorData, newdata));
        }

        // now clean up
        _doorId = _doorScene = _destinationScene = 0;
        _destinationLoc = null;

        _ui.close();
        _ui = null;
        _container = null;
        _ctx = null;
    }

    /** Used to round locations to nearest hundredths to avoid giant actionData strings. */
    protected function roundCoord (value :Number) :Number
    {
        return Math.round(value / .01) * .01;
    }

    /** Creates the UI. */
    protected function makeUI () :FloatingPanel
    {
        var panel :FloatingPanel = new FloatingPanel(_ctx, Msgs.EDITING.get("t.edit_door"));
        panel.showCloseButton = true;

        var label :Text = new Text();
        label.text = Msgs.EDITING.get("l.edit_door_label");
        panel.addChild(label);

        var elts :HBox = new HBox();
        elts.setStyle("right", 2);
        elts.setStyle("left", 2);
        elts.setStyle("top", 20);
        elts.setStyle("bottom", 2);
        elts.verticalScrollPolicy = ScrollPolicy.OFF;
        panel.addChild(elts);

        var bcommit :Button = new Button();
        bcommit.label = Msgs.EDITING.get("b.edit_door_ok");
        bcommit.addEventListener(MouseEvent.CLICK, select);
        elts.addChild(bcommit);

        var bpurchase :Button = new Button();
        bpurchase.label = Msgs.EDITING.get("b.buy_room");
        bpurchase.addEventListener(MouseEvent.CLICK, purchase);
        elts.addChild(bpurchase);

        return panel;
    }

    /**
     * Called when the player hits the 'close' button. Cancels editing.
     */
    public function cancel (event :MouseEvent) :void
    {
        deinit();
    }

    /**
     * Called when the player hits the 'select' button.
     */
    protected function select (event :MouseEvent) :void
    {
        var sd :SceneDirector = _ctx.getSceneDirector();
        if (sd != null) {
            // the door should point to where we are right now
            setDoor(sd.getScene().getId());
        }
    }

    /**
     * Called when the player hits the 'purchase' button.
     */
    protected function purchase (event :MouseEvent) :void
    {
        var listener :ResultWrapper =
            new ResultWrapper (
                function (cause :String) :void
                {   // failure handler
                    Log.getLog(this).info("Room purchase failure: " + cause);
                    _ctx.displayFeedback(null, cause);
                },
                function (result :Object) :void
                {   // success handler
                    if (result != null) {
                        var newSceneId :int = int(Number(result));
                        // Log.getLog(this).info("Room purchase success, id = " + newSceneId);
                        setDoor(newSceneId);
                    }
                });

        _ctx.getWorldDirector().purchaseRoom(listener);
    }

    /**
     * Given the target scene Id, this function starts the chain of events that will
     * set the door target and move the player back to the room where the door was.
     */
    protected function setDoor (targetSceneId :int) :void
    {
        // the sequence of events started by this function is as follows:
        // 1. we remember the current scene as the new target, and issue a request
        //    to transfer the player back to the scene with the door.
        // 2. once we've traveled there, we set the door target to point to the new location.
        //
        // this baroque order of operations reflects a usage pattern in our code,
        // which requires that a scene be loaded up before it can be edited.

        var sd :SceneDirector = _ctx.getSceneDirector();
        if (sd == null) {
            Log.getLog(this).warning("Room purchase failure: scene director not initialized.");
            return;
        }

        var scene :MsoyScene = sd.getScene() as MsoyScene;

        // remember the target
        _destinationScene = targetSceneId;
        _destinationLoc = _ctx.getSpotSceneDirector().getIntendedLocation() as MsoyLocation;

        // are we already in the room with the door?
        if (scene.getId() == _doorScene) {

            // get ready to rock!
            finalizeCommit(scene);

        } else {

            // move the player back to the room with the door
            sd.moveTo(_doorScene);
            // the rest will be triggered via updateLocation(), once we get there...
        }
    }

    /**
     * Called when the player enters a new room. If we're committing a door, and we
     * just traveled to the room where the door was placed, finish up editing.
     */
    public static function updateLocation () :void
    {
        // we only care about this if we're actually in the process of setting a target door
        if (committing) {
            var scene :MsoyScene = _this._ctx.getSceneDirector().getScene() as MsoyScene;

            // if we're editing, and we traversed back to the original door location,
            // update the door and end editing.
            if (scene.getId() == _this._doorScene) {
                _this.finalizeCommit(scene);
            }
        }
    }

    /**
     * Called after we've returned to the room with the door, will set the door's target.
     */
    protected function finalizeCommit (scene :MsoyScene) :void
    {
        // find the door furni
        var furnis :Array = scene.getFurni();
        for each (var data :FurniData in furnis) {
            // check to make sure the object still exists there, and is still a door.
            // todo: we probably want some kind of a lock here.
            if (data.itemId == _doorId && data.actionType == FurniData.ACTION_PORTAL) {
                deinit(data);
                return;
            }
        }

        // the door went away? just cancel.
        deinit();
    }

    /** Singleton constant. */
    protected static var _this :DoorTargetEditController = new DoorTargetEditController();

    /** Scene ID where the door resides. */
    protected var _doorScene :int = 0;

    /** Item ID of the door. */
    protected var _doorId :int = 0;

    /** Scene ID of the door destination. */
    protected var _destinationScene :int = 0;

    /** The location at which to arrive in our destination. */
    protected var _destinationLoc :MsoyLocation;

    /** Flex container for the scene. */
    protected var _container :Container;

    /** World context, what else? */
    protected var _ctx :WorldContext;

    /** Canvas that contains the editing UI. */
    protected var _ui :FloatingPanel;
}
}


